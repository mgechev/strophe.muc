(function(){var t,e,n,i=function(t,e){return function(){return t.apply(e,arguments)}};Strophe.addConnectionPlugin("muc",{_connection:null,rooms:{},roomNames:[],init:function(t){return this._connection=t,this._muc_handler=null,Strophe.addNamespace("MUC_OWNER",Strophe.NS.MUC+"#owner"),Strophe.addNamespace("MUC_ADMIN",Strophe.NS.MUC+"#admin"),Strophe.addNamespace("MUC_USER",Strophe.NS.MUC+"#user"),Strophe.addNamespace("MUC_ROOMCONF",Strophe.NS.MUC+"#roomconfig")},join:function(t,e,i,o,r,s,c){var h,u;return u=this.test_append_nick(t,e),h=$pres({from:this._connection.jid,to:u}).c("x",{xmlns:Strophe.NS.MUC}),null!=c&&(h=h.c("history",c)),null!=s&&h.cnode(Strophe.xmlElement("password",[],s)),null==this._muc_handler&&(this._muc_handler=this._connection.addHandler(function(e){return function(n){var i,o,r,s,c,h,u,a,l,d;if(i=n.getAttribute("from"),!i)return!0;if(c=i.split("/")[0],!e.rooms[c])return!0;if(t=e.rooms[c],r={},"message"===n.nodeName)r=t._message_handlers;else if("presence"===n.nodeName&&(a=n.getElementsByTagName("x"),a.length>0))for(l=0,d=a.length;d>l;l++)if(h=a[l],u=h.getAttribute("xmlns"),u&&u.match(Strophe.NS.MUC)){r=t._presence_handlers;break}for(s in r)o=r[s],o(n,t)||delete r[s];return!0}}(this))),this.rooms.hasOwnProperty(t)||(this.rooms[t]=new n(this,t,e,s),this.roomNames.push(t)),o&&this.rooms[t].addHandler("presence",o),i&&this.rooms[t].addHandler("message",i),r&&this.rooms[t].addHandler("roster",r),this._connection.send(h)},leave:function(t,e,n,i){var o,r,s,c;return o=this.roomNames.indexOf(t),delete this.rooms[t],o>=0&&(this.roomNames.splice(o,1),0===this.roomNames.length&&(this._connection.deleteHandler(this._muc_handler),this._muc_handler=null)),c=this.test_append_nick(t,e),s=this._connection.getUniqueId(),r=$pres({type:"unavailable",id:s,from:this._connection.jid,to:c}),null!=i&&r.c("status",i),null!=n&&this._connection.addHandler(n,null,"presence",null,s),this._connection.send(r),s},message:function(t,e,n,i,o){var r,s,c,h;return h=this.test_append_nick(t,e),o=o||(null!=e?"chat":"groupchat"),s=this._connection.getUniqueId(),r=$msg({to:h,from:this._connection.jid,type:o,id:s}).c("body",{xmlns:Strophe.NS.CLIENT}).t(n),r.up(),null!=i&&(r.c("html",{xmlns:Strophe.NS.XHTML_IM}).c("body",{xmlns:Strophe.NS.XHTML}).t(i),0===r.node.childNodes.length?(c=r.node.parentNode,r.up().up(),r.node.removeChild(c)):r.up().up()),r.c("x",{xmlns:"jabber:x:event"}).c("composing"),this._connection.send(r),s},groupchat:function(t,e,n){return this.message(t,null,e,n)},invite:function(t,e,n){var i,o;return o=this._connection.getUniqueId(),i=$msg({from:this._connection.jid,to:t,id:o}).c("x",{xmlns:Strophe.NS.MUC_USER}).c("invite",{to:e}),null!=n&&i.c("reason",n),this._connection.send(i),o},directInvite:function(t,e,n,i){var o,r,s;return s=this._connection.getUniqueId(),o={xmlns:"jabber:x:conference",jid:t},null!=n&&(o.reason=n),null!=i&&(o.password=i),r=$msg({from:this._connection.jid,to:e,id:s}).c("x",o),this._connection.send(r),s},queryOccupants:function(t,e,n){var i,o;return i={xmlns:Strophe.NS.DISCO_ITEMS},o=$iq({from:this._connection.jid,to:t,type:"get"}).c("query",i),this._connection.sendIQ(o,e,n)},configure:function(t,e,n){var i,o;return i=$iq({to:t,type:"get"}).c("query",{xmlns:Strophe.NS.MUC_OWNER}),o=i.tree(),this._connection.sendIQ(o,e,n)},cancelConfigure:function(t){var e,n;return e=$iq({to:t,type:"set"}).c("query",{xmlns:Strophe.NS.MUC_OWNER}).c("x",{xmlns:"jabber:x:data",type:"cancel"}),n=e.tree(),this._connection.sendIQ(n)},saveConfiguration:function(t,e,n,i){var o,r,s,c,h;if(r=$iq({to:t,type:"set"}).c("query",{xmlns:Strophe.NS.MUC_OWNER}),e instanceof Form)e.type="submit",r.cnode(e.toXML());else for(r.c("x",{xmlns:"jabber:x:data",type:"submit"}),c=0,h=e.length;h>c;c++)o=e[c],r.cnode(o).up();return s=r.tree(),this._connection.sendIQ(s,n,i)},createInstantRoom:function(t,e,n){var i;return i=$iq({to:t,type:"set"}).c("query",{xmlns:Strophe.NS.MUC_OWNER}).c("x",{xmlns:"jabber:x:data",type:"submit"}),this._connection.sendIQ(i.tree(),e,n)},setTopic:function(t,e){var n;return n=$msg({to:t,from:this._connection.jid,type:"groupchat"}).c("subject",{xmlns:"jabber:client"}).t(e),this._connection.send(n.tree())},_modifyPrivilege:function(t,e,n,i,o){var r;return r=$iq({to:t,type:"set"}).c("query",{xmlns:Strophe.NS.MUC_ADMIN}).cnode(e.node),null!=n&&r.c("reason",n),this._connection.sendIQ(r.tree(),i,o)},modifyRole:function(t,e,n,i,o,r){var s;return s=$build("item",{nick:e,role:n}),this._modifyPrivilege(t,s,i,o,r)},kick:function(t,e,n,i,o){return this.modifyRole(t,e,"none",n,i,o)},voice:function(t,e,n,i,o){return this.modifyRole(t,e,"participant",n,i,o)},mute:function(t,e,n,i,o){return this.modifyRole(t,e,"visitor",n,i,o)},op:function(t,e,n,i,o){return this.modifyRole(t,e,"moderator",n,i,o)},deop:function(t,e,n,i,o){return this.modifyRole(t,e,"participant",n,i,o)},modifyAffiliation:function(t,e,n,i,o,r){var s;return s=$build("item",{jid:e,affiliation:n}),this._modifyPrivilege(t,s,i,o,r)},ban:function(t,e,n,i,o){return this.modifyAffiliation(t,e,"outcast",n,i,o)},member:function(t,e,n,i,o){return this.modifyAffiliation(t,e,"member",n,i,o)},revoke:function(t,e,n,i,o){return this.modifyAffiliation(t,e,"none",n,i,o)},owner:function(t,e,n,i,o){return this.modifyAffiliation(t,e,"owner",n,i,o)},admin:function(t,e,n,i,o){return this.modifyAffiliation(t,e,"admin",n,i,o)},changeNick:function(t,e){var n,i;return i=this.test_append_nick(t,e),n=$pres({from:this._connection.jid,to:i,id:this._connection.getUniqueId()}),this._connection.send(n.tree())},setStatus:function(t,e,n,i){var o,r;return r=this.test_append_nick(t,e),o=$pres({from:this._connection.jid,to:r}),null!=n&&o.c("show",n).up(),null!=i&&o.c("status",i),this._connection.send(o.tree())},listRooms:function(t,e,n){var i;return i=$iq({to:t,from:this._connection.jid,type:"get"}).c("query",{xmlns:Strophe.NS.DISCO_ITEMS}),this._connection.sendIQ(i,e,n)},test_append_nick:function(t,e){return t+(null!=e?"/"+Strophe.escapeNode(e):"")}}),n=function(){function e(t,e,n,o){this.client=t,this.name=e,this.nick=n,this.password=o,this._roomRosterHandler=i(this._roomRosterHandler,this),this._addOccupant=i(this._addOccupant,this),this.roster={},this._message_handlers={},this._presence_handlers={},this._roster_handlers={},this._handler_ids=0,t.muc&&(this.client=t.muc),this.name=Strophe.getBareJidFromJid(e),this.addHandler("presence",this._roomRosterHandler)}return e.prototype.join=function(t,e,n){return this.client.join(this.name,this.nick,t,e,n,this.password)},e.prototype.leave=function(t,e){return this.client.leave(this.name,this.nick,t,e),delete this.client.rooms[this.name]},e.prototype.message=function(t,e,n,i){return this.client.message(this.name,t,e,n,i)},e.prototype.groupchat=function(t,e){return this.client.groupchat(this.name,t,e)},e.prototype.invite=function(t,e){return this.client.invite(this.name,t,e)},e.prototype.directInvite=function(t,e){return this.client.directInvite(this.name,t,e,this.password)},e.prototype.configure=function(t){return this.client.configure(this.name,t)},e.prototype.cancelConfigure=function(){return this.client.cancelConfigure(this.name)},e.prototype.saveConfiguration=function(t){return this.client.saveConfiguration(this.name,t)},e.prototype.queryOccupants=function(t,e){return this.client.queryOccupants(this.name,t,e)},e.prototype.setTopic=function(t){return this.client.setTopic(this.name,t)},e.prototype.modifyRole=function(t,e,n,i,o){return this.client.modifyRole(this.name,t,e,n,i,o)},e.prototype.kick=function(t,e,n,i){return this.client.kick(this.name,t,e,n,i)},e.prototype.voice=function(t,e,n,i){return this.client.voice(this.name,t,e,n,i)},e.prototype.mute=function(t,e,n,i){return this.client.mute(this.name,t,e,n,i)},e.prototype.op=function(t,e,n,i){return this.client.op(this.name,t,e,n,i)},e.prototype.deop=function(t,e,n,i){return this.client.deop(this.name,t,e,n,i)},e.prototype.modifyAffiliation=function(t,e,n,i,o){return this.client.modifyAffiliation(this.name,t,e,n,i,o)},e.prototype.ban=function(t,e,n,i){return this.client.ban(this.name,t,e,n,i)},e.prototype.member=function(t,e,n,i){return this.client.member(this.name,t,e,n,i)},e.prototype.revoke=function(t,e,n,i){return this.client.revoke(this.name,t,e,n,i)},e.prototype.owner=function(t,e,n,i){return this.client.owner(this.name,t,e,n,i)},e.prototype.admin=function(t,e,n,i){return this.client.admin(this.name,t,e,n,i)},e.prototype.changeNick=function(t){return this.nick=t,this.client.changeNick(this.name,t)},e.prototype.setStatus=function(t,e){return this.client.setStatus(this.name,this.nick,t,e)},e.prototype.addHandler=function(t,e){var n;switch(n=this._handler_ids++,t){case"presence":this._presence_handlers[n]=e;break;case"message":this._message_handlers[n]=e;break;case"roster":this._roster_handlers[n]=e;break;default:return this._handler_ids--,null}return n},e.prototype.removeHandler=function(t){return delete this._presence_handlers[t],delete this._message_handlers[t],delete this._roster_handlers[t]},e.prototype._addOccupant=function(e){var n;return n=new t(e,this),this.roster[n.nick]=n,n},e.prototype._roomRosterHandler=function(t){var n,i,o,r,s,c;switch(n=e._parsePresence(t),s=n.nick,r=n.newnick||null,n.type){case"error":return;case"unavailable":r&&(n.nick=r,this.roster[s]&&this.roster[r]&&(this.roster[s].update(this.roster[r]),this.roster[r]=this.roster[s]),this.roster[s]&&!this.roster[r]&&(this.roster[r]=this.roster[s].update(n))),delete this.roster[s];break;default:this.roster[s]?this.roster[s].update(n):this._addOccupant(n)}c=this._roster_handlers;for(o in c)i=c[o],i(this.roster,this)||delete this._roster_handlers[o];return!0},e._parsePresence=function(t){var e,n,i,o,r,s,c,h,u,a,l,d,p,m,f,_;for(o={},e=t.attributes,o.nick=Strophe.getResourceFromJid(e.from.textContent),o.type=(null!=(u=e.type)?u.textContent:void 0)||null,o.states=[],a=t.childNodes,r=0,c=a.length;c>r;r++)switch(n=a[r],n.nodeName){case"status":o.status=n.textContent||null;break;case"show":o.show=n.textContent||null;break;case"x":if(e=n.attributes,(null!=(l=e.xmlns)?l.textContent:void 0)===Strophe.NS.MUC_USER)for(d=n.childNodes,s=0,h=d.length;h>s;s++)switch(i=d[s],i.nodeName){case"item":e=i.attributes,o.affiliation=(null!=(p=e.affiliation)?p.textContent:void 0)||null,o.role=(null!=(m=e.role)?m.textContent:void 0)||null,o.jid=(null!=(f=e.jid)?f.textContent:void 0)||null,o.newnick=(null!=(_=e.nick)?_.textContent:void 0)||null;break;case"status":i.attributes.code&&o.states.push(i.attributes.code.textContent)}}return o},e}(),e=function(){function t(t){this.parse=i(this.parse,this),null!=t&&this.parse(t)}return t.prototype.parse=function(t){var e,n,i,o,r,s,c,h,u,a,l,d,p;for(s=t.getElementsByTagName("query")[0].childNodes,this.identities=[],this.features=[],this.x=[],c=0,a=s.length;a>c;c++)switch(i=s[c],n=i.attributes,i.nodeName){case"identity":for(r={},h=0,l=n.length;l>h;h++)e=n[h],r[e.name]=e.textContent;this.identities.push(r);break;case"feature":this.features.push(n["var"].textContent);break;case"x":if(n=i.childNodes[0].attributes,"FORM_TYPE"===!n["var"].textContent||"hidden"===!n.type.textContent)break;for(p=i.childNodes,u=0,d=p.length;d>u;u++)o=p[u],o.attributes.type||(n=o.attributes,this.x.push({"var":n["var"].textContent,label:n.label.textContent||"",value:o.firstChild.textContent||""}))}return{identities:this.identities,features:this.features,x:this.x}},t}(),t=function(){function t(t,e){this.room=e,this.update=i(this.update,this),this.admin=i(this.admin,this),this.owner=i(this.owner,this),this.revoke=i(this.revoke,this),this.member=i(this.member,this),this.ban=i(this.ban,this),this.modifyAffiliation=i(this.modifyAffiliation,this),this.deop=i(this.deop,this),this.op=i(this.op,this),this.mute=i(this.mute,this),this.voice=i(this.voice,this),this.kick=i(this.kick,this),this.modifyRole=i(this.modifyRole,this),this.update(t)}return t.prototype.modifyRole=function(t,e,n,i){return this.room.modifyRole(this.nick,t,e,n,i)},t.prototype.kick=function(t,e,n){return this.room.kick(this.nick,t,e,n)},t.prototype.voice=function(t,e,n){return this.room.voice(this.nick,t,e,n)},t.prototype.mute=function(t,e,n){return this.room.mute(this.nick,t,e,n)},t.prototype.op=function(t,e,n){return this.room.op(this.nick,t,e,n)},t.prototype.deop=function(t,e,n){return this.room.deop(this.nick,t,e,n)},t.prototype.modifyAffiliation=function(t,e,n,i){return this.room.modifyAffiliation(this.jid,t,e,n,i)},t.prototype.ban=function(t,e,n){return this.room.ban(this.jid,t,e,n)},t.prototype.member=function(t,e,n){return this.room.member(this.jid,t,e,n)},t.prototype.revoke=function(t,e,n){return this.room.revoke(this.jid,t,e,n)},t.prototype.owner=function(t,e,n){return this.room.owner(this.jid,t,e,n)},t.prototype.admin=function(t,e,n){return this.room.admin(this.jid,t,e,n)},t.prototype.update=function(t){return this.nick=t.nick||null,this.affiliation=t.affiliation||null,this.role=t.role||null,this.jid=t.jid||null,this.status=t.status||null,this.show=t.show||null,this},t}()}).call(this);